<div data-controller="post-form post-form-validation" data-validation-url="<%= validate_form_path %>">
  <% # Route based on post state: new/draft to save_draft, published to posts %>
  <% form_url = @post.new_record? || @post.draft? ? save_draft_post_path : posts_path %>
  
  <%= form_with(model: @post, url: form_url, method: :post, local: true, html: { multipart: true, id: "post-form", data: { validation_type: "post" } }, class: "space-y-6") do |form| %>
    <% # Include post ID for draft updates %>
    <% if @post.persisted? %>
      <%= hidden_field_tag :id, @post.id %>
    <% end %>
    <% if @post.errors.any? %>
      <div class="bg-rose-900/50 border border-rose-500/50 rounded-lg p-4">
        <h2 class="text-sm font-semibold text-rose-200 mb-2"><%= pluralize(@post.errors.count, "error") %> prohibited this post from being saved:</h2>
        <ul class="list-disc list-inside text-rose-100 text-sm space-y-1">
          <% @post.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <!-- Title with Real-Time Validation -->
    <div>
      <%= form.label :title, class: "block text-sm font-semibold text-slate-200 mb-2" %>
      <%= form.text_field :title, 
          "data-post-form-validation-target": "title",
          placeholder: "Post title (3-200 characters)",
          class: "w-full bg-slate-800/50 border border-slate-600/50 rounded-lg px-4 py-3 text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition" %>
      <!-- Feedback will be inserted here by controller -->
    </div>

    <!-- Content with Real-Time Validation -->
    <div>
      <%= form.label :content, class: "block text-sm font-semibold text-slate-200 mb-2" %>
      <%= form.text_area :content, 
          rows: 6,
          "data-post-form-validation-target": "content",
          placeholder: "Share your thoughts, reviews, or discussions about anime! (1-5000 characters)",
          class: "w-full bg-slate-800/50 border border-slate-600/50 rounded-lg px-4 py-3 text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition resize-none" %>
      <!-- Feedback and character counter will be inserted here by controller -->
    </div>

    <!-- Images -->
    <div>
      <label class="block text-sm font-semibold text-slate-200 mb-2">Images</label>
      <div id="post-images-container" data-target="post-form.container" class="space-y-3">
        <%= form.fields_for :post_images do |image_form| %>
          <%= render "posts/image_fields", form: image_form %>
        <% end %>
      </div>
      <button id="add-image-btn" type="button" class="mt-4 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-semibold transition cursor-pointer">+ Add Image</button>
    </div>

    <!-- Submit Buttons -->
    <div class="flex gap-3 pt-4">
      <% if @post.persisted? && @post.draft? %>
        <!-- Editing existing draft: Save or Publish -->
        <%= form.submit "Save Changes", name: "action_type", value: "save", "data-post-form-validation-target": "submitButton", class: "px-6 py-2 bg-green-400 hover:bg-green-500 disabled:opacity-60 disabled:cursor-not-allowed text-white rounded-lg transition font-semibold" %>
        <%= form.submit "Publish", name: "action_type", value: "publish", "data-post-form-validation-target": "submitButton", class: "px-6 py-2 bg-gradient-to-r from-green-600 to-emerald-600 disabled:opacity-60 disabled:cursor-not-allowed text-white rounded-lg hover:shadow-lg hover:shadow-green-500/50 transition font-semibold" %>
      <% elsif @post.new_record? %>
        <!-- Creating new post: Publish or Save as Draft -->
        <%= form.submit "Publish", name: "action_type", value: "publish", "data-post-form-validation-target": "submitButton", class: "px-6 py-2 bg-gradient-to-r from-purple-600 to-pink-600 disabled:opacity-60 disabled:cursor-not-allowed text-white rounded-lg hover:shadow-lg hover:shadow-purple-500/50 transition font-semibold" %>
        <%= form.submit "Save", name: "action_type", value: "save", "data-post-form-validation-target": "submitButton", class: "px-6 py-2 bg-green-400 hover:bg-green-500 disabled:opacity-60 disabled:cursor-not-allowed text-white rounded-lg transition font-semibold" %>
      <% end %>
      <%= link_to "Cancel", @post.draft? ? drafts_posts_path : posts_path, class: "px-6 py-2 bg-slate-700/50 hover:bg-slate-700 text-slate-200 rounded-lg transition font-semibold" %>
    </div>
  <% end %>
</div>

<script>
  // Fallback for Add Image when Stimulus isn't available (works without npm build)
  (function() {
    function addImageField() {
      const container = document.getElementById('post-images-container')
      if (!container) return
      const newIndex = Math.floor(Math.random() * 10000)
      const wrapper = document.createElement('div')
      wrapper.className = 'flex gap-3 items-end image-wrapper'
      wrapper.innerHTML = `
        <div class="flex-1">
          <input type="file" accept="image/*" name="post[post_images_attributes][${newIndex}][image]" class="w-full bg-slate-800/50 border border-slate-600/50 rounded-lg px-3 py-2 text-slate-100 file:mr-4 file:py-2 file:px-3 file:rounded file:border-0 file:bg-purple-600 file:text-white file:font-semibold file:cursor-pointer hover:file:bg-purple-700" />
        </div>
        <button type="button" class="px-4 py-2 bg-rose-600/50 hover:bg-rose-600 text-rose-100 rounded-lg text-sm font-semibold transition remove-image-btn">Remove</button>
      `
      container.appendChild(wrapper)
    }

    function removeImage(event) {
      const btn = event.target
      if (!btn.classList.contains('remove-image-btn')) return
      event.preventDefault()
      const wrapper = btn.closest('.image-wrapper')
      if (wrapper) wrapper.remove()
    }

    function cleanupEmptyImages(event) {
      const imageInputs = document.querySelectorAll('input[name*="post_images_attributes"][type="file"]')
      imageInputs.forEach(input => {
        if (!input.files || input.files.length === 0) {
          const wrapper = input.closest('.image-wrapper')
          if (wrapper) wrapper.remove()
        }
      })
    }

    // Save draft handler
    function saveDraft(event) {
      event.preventDefault()
      const form = document.getElementById('post-form')
      const formData = new FormData(form)
      
      fetch('<%= save_draft_post_path %>', {
        method: 'POST',
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert('Draft saved successfully!')
          window.location.href = '<%= drafts_posts_path %>'
        } else {
          alert('Error saving draft: ' + data.errors.join(', '))
        }
      })
      .catch(error => {
        console.error('Error:', error)
        alert('Error saving draft. Please try again.')
      })
    }

    document.addEventListener('DOMContentLoaded', function() {
      const addBtn = document.getElementById('add-image-btn')
      if (addBtn) addBtn.addEventListener('click', addImageField)
      document.addEventListener('click', removeImage)
      
      const form = document.getElementById('post-form')
      if (form) {
        form.addEventListener('submit', cleanupEmptyImages)
      }

      // Save draft button handler
      const saveDraftBtn = document.getElementById('save-draft-btn')
      if (saveDraftBtn) {
        saveDraftBtn.addEventListener('click', saveDraft)
      }
    })
  })()
</script>
